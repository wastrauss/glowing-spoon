name: Sync & Sort Translations

on:
  push:
    paths:
      - 'translations/*.yml' # Updated to translations folder
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  manage-translations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install js-yaml

      - name: Run Translation Manager
        run: node scripts/translation-manager.js

      - name: Commit and Push Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Updated email as requested
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check for changes in the translations folder
          if [[ -n $(git status -s) ]]; then
            git add translations/*.yml
            
            # [skip ci] prevents infinite loops
            git commit -m "chore: auto-sort and sync translation keys [skip ci]"
            
            # Authenticate using the token
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
            
            git push
          else
            echo "No changes detected."
          fi

      - name: Check for Orphan Report
        id: check_report
        run: |
          if [ -f "orphan_report.md" ]; then
            echo "orphans_found=true" >> $GITHUB_OUTPUT
          else
            echo "orphans_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue for Orphans
        if: steps.check_report.outputs.orphans_found == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "⚠️ Orphaned Translation Keys"
          content-filepath: ./orphan_report.md
          assignees: ${{ github.actor }} # Assigns the person who pushed the code
          labels: |
            maintenance
            i18n