name: Sync & Sort Translations

on:
  push:
    paths:
      - 'translations/*.yml' # Only run when translation files change
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  manage-translations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        # We install js-yaml on the fly so you don't need it in your package.json
        run: npm install js-yaml

      - name: Run Translation Manager
        run: node scripts/translation-manager.js

      - name: Commit and Push Changes
        env: 
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
          # Check for changes
          if [[ -n $(git status -s) ]]; then
            git add translations/*.yml
            git commit -m "chore: auto-sort and sync translation keys"
            
            # Set the remote URL to use the GITHUB_TOKEN for authentication
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
            
            git push
          else
            echo "No changes detected."
          fi

      - name: Check for Orphan Report
        id: check_report
        run: |
          if [ -f "orphan_report.md" ]; then
            echo "orphans_found=true" >> $GITHUB_OUTPUT
          else
            echo "orphans_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue for Orphans
        if: steps.check_report.outputs.orphans_found == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "⚠️ Orphaned Translation Keys"
          content-filepath: ./orphan_report.md
          labels: |
            maintenance
            i18n